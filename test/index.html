<!DOCTYPE html>
<html>
<head>
  <title>OSM Buildings</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .control {
      position: absolute;
      left: 0;
      z-index: 1000;
    }

    .control.tilt {
      top: 0;
    }

    .control.rotation {
      top: 45px;
    }

    .control.zoom {
      top: 90px;
    }

    .control.zoom button{
      font-weight: normal;
    }

    .control button {
      width: 30px;
      height: 30px;
      margin: 15px 0 0 15px;
      border: 1px solid #999999;
      background: #ffffff;
      opacity: 0.6;
      border-radius: 5px;
      box-shadow: 0 0 5px #666666;
      font-weight: bold;
      text-align: center;
    }

    .control button:hover {
      opacity: 1;
      cursor: pointer;
    }
  </style>
  <link rel="stylesheet" href="../dist/OSMBuildings/OSMBuildings.css">
  <script src="loader.js"></script>
</head>

<body>
<!--<div id="map" style="position:absolute;top:100px"></div>-->
<div id="map"></div>

<div id="label" style="width:10px;height:10px;position:absolute;z-Index:1000;border:3px solid red;"></div>

<div style="position:absolute;left:100px;top:20px;border:1px solid #ff8888; background:#fff;font-family:sans-serif;padding:10px;font-size:12px;}">Click?</div>

<div class="control tilt">
  <button class="dec">&#8601;</button>
  <button class="inc">&#8599;</button>
</div>

<div class="control rotation">
  <button class="inc">&#8630;</button>
  <button class="dec">&#8631;</button>
</div>

<div class="control zoom">
  <button class="dec">-</button>
  <button class="inc">+</button>
</div>

<script>
(function(e,t){"use strict";var n=function(){var e=function(e,s,o){if(!s){s="rgba"}e=e.toLowerCase();s=s.toLowerCase();var a=u(e),f=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(e){return[parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),1]}},{re:/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3}),\s*(\d+(?:\.\d+)?|\.\d+)\s*\)/,example:["rgba(123, 234, 45, 1)","rgba(255,234,245, 0.5)"],process:function(e){return[parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),parseFloat(e[4])]}},{re:/^hsl\((\d{1,3}),\s*(\d{1,3})%,\s*(\d{1,3})%\)$/,example:["hsl(120, 100%, 25%)","hsl(0, 100%, 50%)"],process:function(e){e[4]=1;var n=t(e);return[n.r,n.g,n.b,n.a]}},{re:/^hsla\((\d{1,3}),\s*(\d{1,3})%,\s*(\d{1,3})%,\s*(\d+(?:\.\d+)?|\.\d+)\s*\)/,example:["hsla(120, 100%, 25%, 1)","hsla(0, 100%, 50%, 0.5)"],process:function(e){var n=t(e);return[n.r,n.g,n.b,n.a]}},{re:/^hsv\((\d{1,3}),\s*(\d{1,3})%,\s*(\d{1,3})%\)$/,example:["hsv(120, 100%, 25%)","hsl(0, 100%, 50%)"],process:function(e){var t=r(e);return[t.r,t.g,t.b,1]}},{re:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,example:["#00ff00","336699"],process:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),1]}},{re:/^([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,example:["#fb0","f0f"],process:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16),1]}}],l,c,h,p,d,v,m,g,y,b,w,E,S;if(a){e=a}else{e=e.replace(/^\s*#|\s*$/g,"");if(e.length===3){e=e.replace(/(.)/g,"$1$1")}}for(d=0;d<f.length;d+=1){v=f[d].re;m=f[d].process;g=v.exec(e);if(g){y=m(g);l=y[0];c=y[1];h=y[2];p=y[3]}}l=l<0||isNaN(l)?0:l>255?255:l;c=c<0||isNaN(c)?0:c>255?255:c;h=h<0||isNaN(h)?0:h>255?255:h;p=p<0||isNaN(p)?0:p>1?1:p;switch(s){case"rgba":if(o){p=(255-(b=Math.min(l,c,h)))/255;l=(0||(l-b)/p).toFixed(0);c=(0||(c-b)/p).toFixed(0);h=(0||(h-b)/p).toFixed(0);p=p.toFixed(4)}S="rgba("+l+","+c+","+h+","+p+")";break;case"rgb":S="rgb("+l+","+c+","+h+")";break;case"hex":S="#"+("0"+l.toString(16)).slice(-2)+("0"+c.toString(16)).slice(-2)+("0"+h.toString(16)).slice(-2);break;case"hsl":w=n({r:l,g:c,b:h});S="hsl("+w.h+","+w.s+"%,"+w.l+"%)";break;case"hsla":w=n({r:l,g:c,b:h,a:p});S="hsl("+w.h+","+w.s+"%,"+w.l+"%,"+w.a+")";break;case"hsv":E=i({r:l,g:c,b:h});S="hsv("+E.h+","+E.s+"%,"+E.v+"%)";break}return S},t=function(e){var t={},n,r,i,u={h:o(parseInt(e[1],10)%360,360),s:o(parseInt(e[2],10)%101,100),l:o(parseInt(e[3],10)%101,100),a:parseFloat(e[4])};if(u.s===0){n=parseInt(Math.round(255*u.l));t={r:n,g:n,b:n,a:u.a}}else{r=u.l<.5?u.l*(1+u.s):u.l+u.s-u.l*u.s;i=2*u.l-r;t.r=parseInt((s(i,r,u.h+1/3)*256).toFixed(0),10);t.g=parseInt((s(i,r,u.h)*256).toFixed(0),10);t.b=parseInt((s(i,r,u.h-1/3)*256).toFixed(0),10);t.a=u.a}return t},n=function(e){e.r=o(parseInt(e.r,10)%256,256);e.g=o(parseInt(e.g,10)%256,256);e.b=o(parseInt(e.b,10)%256,256);var t=Math.max(e.r,e.g,e.b),n=Math.min(e.r,e.g,e.b),r=[],i;r.a=e.a;r.l=(t+n)/2;if(t===n){r.h=0;r.s=0}else{i=t-n;r.s=r.l>.5?i/(2-t-n):i/(t+n);switch(t){case e.r:r.h=(e.g-e.b)/i+(e.g<e.b?6:0);break;case e.g:r.h=(e.b-e.r)/i+2;break;case e.b:r.h=(e.r-e.g)/i+4;break}r.h/=6}r.h=parseInt((r.h*360).toFixed(0),10);r.s=parseInt((r.s*100).toFixed(0),10);r.l=parseInt((r.l*100).toFixed(0),10);return r},r=function(e){var t={},n={h:o(parseInt(e[1],10)%360,360),s:o(parseInt(e[2],10)%101,100),v:o(parseInt(e[3],10)%101,100)},r=Math.floor(n.h*6),i=n.h*6-r,s=n.v*(1-n.s),u=n.v*(1-i*n.s),a=n.v*(1-(1-i)*n.s);switch(r%6){case 0:t.r=n.v;t.g=a;t.b=s;break;case 1:t.r=u;t.g=n.v;t.b=s;break;case 2:t.r=s;t.g=n.v;t.b=a;break;case 3:t.r=s;t.g=u;t.b=n.v;break;case 4:t.r=a;t.g=s;t.b=n.v;break;case 5:t.r=n.v;t.g=s;t.b=u;break}t.r=parseInt(t.r*256,10);t.g=parseInt(t.g*256,10);t.b=parseInt(t.b*256,10);return{r:t.r,g:t.g,b:t.b}},i=function(e){e.r=o(parseInt(e.r,10)%256,256);e.g=o(parseInt(e.g,10)%256,256);e.b=o(parseInt(e.b,10)%256,256);var t=Math.max(e.r,e.g,e.b),n=Math.min(e.r,e.g,e.b),r=t-n,i={h:0,s:t===0?0:r/t,v:t};if(t!==n){switch(t){case e.r:i.h=(e.g-e.b)/r+(e.g<e.b?6:0);break;case e.g:i.h=(e.b-e.r)/r+2;break;case e.b:i.h=(e.r-e.g)/r+4;break}i.h/=6}i.h=parseInt((i.h*360).toFixed(0),10);i.s=parseInt((i.s*100).toFixed(0),10);i.v=parseInt((i.v*100).toFixed(0),10);return i},s=function(e,t,n){if(n<0){n+=1}if(n>1){n-=1}if(n<1/6){return e+(t-e)*6*n}if(n<1/2){return t}if(n<2/3){return e+(t-e)*(2/3-n)*6}return e},o=function(e,t){return e/t},u=function(e){var t,n=null,r={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(t in r){if(e===t){n=r[t]}}return n};return e}();e.color2color=n})(window)

  var map = new GLMap('map', {
    position: { latitude:40.69924, longitude:-74.01692 },
    //bounds: { n:52.52050, e:13.41050, s:52.52000, w:13.41000 },
    zoom: 16,
    minZoom: 12,
    maxZoom: 20,
    // disabled: true, // disables user input
    state: true // stores map position, zoom etc. in url
  });

  //***************************************************************************

  var osmb = new OSMBuildings({
    baseURL: './OSMBuildings',
    minZoom: 12,
    maxZoom: 22,
    showBackfaces: false, 
    fastMode: true,
    effects: ['shadows'],
    attribution: '© 3D <a href="https://osmbuildings.org/copyright/">OSM Buildings</a>'
  }).addTo(map);

  osmb.addMapTiles(
    //'https://{s}.tiles.mapbox.com/v3/osmbuildings.lgh43kca/{z}/{x}/{y}.png',
    //'https://tile.stamen.com/toner/{z}/{x}/{y}.png',
    'https://{s}.tiles.mapbox.com/v3/osmbuildings.kbpalbpk/{z}/{x}/{y}.png',
    {
      attribution: '© Data <a href="http://openstreetmap.org/copyright/">OpenStreetMap</a> · © Map <a href="http://mapbox.com">Mapbox</a>'
    }
  );

  var selector = function(id, data) {
    return id % 2 === 0;
  };

  function showEven(duration) {
    osmb.show(selector, duration || 1000);
  }

  function hideEven(duration) {
    osmb.hide(selector, duration || 1000);
  }

  var colorByHeightAvailable = function(id, properties) {
    if (!properties.levels && !properties.height) {
      properties.color = "red";
    } else if (!properties.height) {
      properties.color = "lime";
    } else {
      properties.color = "green";
    }
    
    properties.roofColor = properties.color;
  };

  var colorByHeight = function(id, properties) {
    var height = parseFloat(properties.height) || (parseFloat(properties.levels)* 3.5) || 0;

    if (height < 20)
      properties.color = "#CCCCCC";
    else if (height < 30)
      properties.color = "purple";
    else if (height < 60)
      properties.color = "#CC4444";
    else 
      properties.color = "orange";
      
    properties.roofColor = properties.color;
  };

  var mapSetup = function(id, properties) {
    //age = 2016-parseFloat(properties.YearBuilt);
    var ped = Math.ceil(parseFloat(properties.ped_energy));
    var min = 20000;
    var max = 300000;
    var percentage = (ped - min) / (max - min);
    var h = Math.ceil( (1.0 - percentage) * 240 );
    properties.height = parseFloat(properties.NumFloors )* 3.5;
    
    if(isNaN(h)){
      var color = "#CCC";
    } else {
      var color = color2color( "hsl("+h+",100%,50%)" );
    }
    properties.color = color
    //console.log(properties.color)
    properties.roofColor = properties.color;
  };
  
  // osmb.addGeoJSONTiles('https://{s}.data.osmbuildings.org/0.2/anonymous/tile/{z}/{x}/{y}.json',{
  //   modifier: colorByHeight,
  //   color: '#CCCCCC'
  // });


  osmb.addGeoJSONTiles('data/osm_ped.json', {modifier: mapSetup});

  //var obj = osmb.addOBJ('../../OBJ2GeoJSON/data/2015-09/o4/o4-nach90.obj', { latitude:52.51941, longitude:13.50445 }, { color: '#00ccff' });
  //osmb.addGeoJSON('../../OBJ2GeoJSON/data/geojson C/o2-nach90.geo.json', { color: '#00ccff' });

  var label = document.getElementById('label');
//  map.on('change', function() {
//    var pos = osmb.project(52.52, 13.37, 50);
//    label.style.left = Math.round(pos.x) + 'px';
//    label.style.top = Math.round(pos.y) + 'px';
//  });

  map.on('pointermove', function(e) {
    osmb.getTarget(e.detail.x, e.detail.y, function(id) {
      if (id) {
        document.body.style.cursor = 'pointer';
        osmb.highlight(id, '#f08000');
      } else {
        document.body.style.cursor = 'default';
        osmb.highlight(null);
      }
   });
  });

//  map.on('pointermove', function(e) {
//    obj.position = osmb.unproject(e.detail.x, e.detail.y);
//  });
//

//  map.on('pointerdown', function(e) {
//    var id = osmb.getTarget(e.detail.x, e.detail.y, function(id) {
//      console.log(id);
//    });
//  });

  //*************************************************************************

  //  osmb.on('idle', function() {
  //    console.log('IDLE');
  //  });
  //
  //  osmb.on('busy', function() {
  //    console.log('BUSY');
  //  });

  //*************************************************************************

  /*
   * ## Key codes for object positioning ##
   * Cursor keys: move
   * +/- : scale
   * w/s : elevate
   * a/d : rotate
   *
   * Pressing Alt the same time accelerates
   */
  function positionOnMap(obj) {
    document.addEventListener('keydown', function(e) {
      var transInc = e.altKey ? 0.0002 : 0.00002;
      var scaleInc = e.altKey ? 0.1 : 0.01;
      var rotaInc = e.altKey ? 10 : 1;
      var eleInc = e.altKey ? 10 : 1;

      switch (e.which) {
        case 37: obj.position.longitude -= transInc; break;
        case 39: obj.position.longitude += transInc; break;
        case 38: obj.position.latitude += transInc; break;
        case 40: obj.position.latitude -= transInc; break;
        case 187: obj.scale += scaleInc; break;
        case 189: obj.scale -= scaleInc; break;
        case 65: obj.rotation += rotaInc; break;
        case 68: obj.rotation -= rotaInc; break;
        case 87: obj.elevation += eleInc; break;
        case 83: obj.elevation -= eleInc; break;
        default: return;
      }
      console.log(JSON.stringify({
        position:{
          latitude:parseFloat(obj.position.latitude.toFixed(5)),
          longitude:parseFloat(obj.position.longitude.toFixed(5))
        },
        elevation:parseFloat(obj.elevation.toFixed(2)),
        scale:parseFloat(obj.scale.toFixed(2)),
        rotation:parseInt(obj.rotation, 10)
      }));
    });
  }

  //*************************************************************************

  if (typeof obj !== 'undefined') positionOnMap(obj);

  var controlButtons = document.querySelectorAll('.control button');

  for (var i = 0, il = controlButtons.length; i < il; i++) {
    controlButtons[i].addEventListener('click', function(e) {
      var button = this;
      var parentClassList = button.parentNode.classList;
      var direction = button.classList.contains('inc') ? 1 : -1;
      var increment;
      var property;

      if (parentClassList.contains('tilt')) {
        property = 'Tilt';
        increment = direction*10;
      }
      if (parentClassList.contains('rotation')) {
        property = 'Rotation';
        increment = direction*10;
      }
      if (parentClassList.contains('zoom')) {
        property = 'Zoom';
        increment = direction*1;
      }
      if (property) {
        map['set'+ property](map['get'+ property]()+increment);
      }
    });
  }
</script>
</body>
</html>
